<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<title>SPDK: iSCSI Target Getting Started Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<link href="https://fonts.googleapis.com/css?family=Roboto:400,900" rel="stylesheet" type="text/css">
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="http://www.spdk.io/css/bootstrap.min.css" rel="stylesheet">
<link href="http://www.spdk.io/css/spdk.css" rel="stylesheet" type="text/css">
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<section id="page">
  <div class="page-header">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="page-title">
            <h1><a href="http://www.spdk.io">Storage Performance Development Kit</a></h1>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">iSCSI Target Getting Started Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Intel(R) Storage Performance Development Kit iSCSI target application is named "iscsi_tgt".</p>
<p>This following section describes how to run iscsi from your cloned package.</p>
<h1><a class="anchor" id="iscsi_prereqs"></a>
Prerequisites</h1>
<p>This guide starts by assuming that you can already build the standard SPDK distribution on your platform. The SPDK iSCSI target has been known to work on several Linux distributions, namely Ubuntu 14.04, 15.04, and 15.10, Fedora 21, 22, and 23, and CentOS 7.</p>
<p>Once built, the binary will be in <code>app/iscsi_tgt</code>.</p>
<h1><a class="anchor" id="iscsi_config"></a>
Configuring iSCSI Target</h1>
<p>A <code>iscsi_tgt</code> specific configuration file is used to configure the iSCSI target. A fully documented example configuration file is located at <code>etc/spdk/iscsi.conf.in</code>.</p>
<p>The configuration file is used to configure the SPDK iSCSI target. This file defines the following: TCP ports to use as iSCSI portals; general iSCSI parameters; initiator names and addresses to allow access to iSCSI target nodes; number and types of storage backends to export over iSCSI LUNs; iSCSI target node mappings between portal groups, initiator groups, and LUNs.</p>
<p>The SPDK iSCSI target supports several different types of storage backends. These backends will create SCSI LUNs which can be exported via iSCSI target nodes.</p>
<p>The storage backends can be configured in the iscsi.conf configuration file to specify the number or size of LUNs, block device names (for exporting in-kernel block devices), or other parameters.</p>
<p>Currently there are 3 types of stroage backends supported by iSCSI target:</p>
<h1>Malloc </h1>
<p>Configuration file syntax: </p><pre class="fragment">[Malloc]
  NumberOfLuns 4
  LunSizeInMB  64
</pre><p>Other TargetNode parameters go here (TargetName, Mapping, etc.): </p><pre class="fragment">[TargetNodeX]
  LUN0 Malloc0
</pre><p>This exports a malloc'd target. The disk is a RAM disk that is a chunk of memory allocated by iscsi in user space. It will use offload engine to do the copy job instead of memcpy if the system has enough DMA channels.</p>
<h1>Block Device </h1>
<p>AIO devices are accessed using Linux AIO. O_DIRECT is used and thus unaligned writes will be double buffered. This option also bypasses the Linux page cache. This mode is probably as close to a typical kernel based target as a user space target can get without using a user-space driver.</p>
<p>Configuration file syntax:</p>
<pre class="fragment">[AIO]
  #normal file or block device
  AIO /dev/sdb
</pre><p>Other TargetNode parameters go here (TargetName, Mapping, etc.): </p><pre class="fragment">[TargetNodeX]
  LUN0 AIO0
</pre><h1>Ceph RBD </h1>
<p>Ceph RBD devices are accessed via librbd and librados libraries to access the RADOS block device exported by Ceph.</p>
<p>Configuration file syntax:</p>
<pre class="fragment">[Ceph]
  # The format of provided rbd info should be: Ceph rbd_pool_name rbd_name size.
  # In the following example, rbd is the name of rbd_pool; foo is the name of
  # rbd device exported by Ceph; value 512 represents the configured block size
  # for this rbd, the block size should be a multiple of 512.
  Ceph rbd foo 512
</pre><p>Other TargetNode parameters go here (TargetName, Mapping, etc.): </p><pre class="fragment">[TargetNodeX]
  LUN0 Ceph0
</pre><h1>NVMe </h1>
<p>The SPDK NVMe driver by default binds to all NVMe controllers which are not bound to the kernel-mode nvme driver. Users can choose to bind to fewer controllers by setting the NumControllers parameter. Then the NVMe backend controls NVMe controller(s) directly from userspace and completely bypasses the kernel to avoid interrupts and context switching.</p>
<pre class="fragment">[Nvme]
  # NVMe Device Whitelist
  # Users may specify which NVMe devices to claim by their PCI
  # domain, bus, device, and function. The format is dddd:bb:dd.f, which is
  # the same format displayed by lspci or in /sys/bus/pci/devices. The second
  # argument is a "name" for the device that can be anything. The name
  # is referenced later in the Subsystem section.
  #
  # Alternatively, the user can specify ClaimAllDevices. All
  # NVMe devices will be claimed.
  BDF 0000:00:00.0
  BDF 0000:01:00.0

  # SPDK supports partitioning each nvme card into multiple LUNs
  #  through the NvmeLunsPerNs parameter. If NvmeLunsPerNs is specified,
  #  then the size of the nvme card is split up equally only if LunSizeinMB
  #  is not specified. For example, a 400GB NVMe namespace would be split
  #  into 4 LUNs, each 100GB in size. These LUNs could be presented
  #  individually (i.e. one LUN per TargetNode), or aggregated into a single
  #  target node as in the example above. Currently, maximal value supported
  #  by NvmeLunsPerNs is 256.
  NvmeLunsPerNs 4

  # The number of attempts per I/O when an I/O fails. Do not include
  # this key to get the default behavior.
  NvmeRetryCount 4
  # The maximum number of NVMe controllers to claim. Do not include this key to
  # claim all of them.
  NumControllers 2

[TargetNodeX]
  # other TargetNode parameters go here (TargetName, Mapping, etc.)
  # nvme with the following format: NvmeXnYpZ, where X = the controller ID,
  # Y = the namespace ID, and Z = the partition ID
  # Note: NVMe namespace IDs always start at 1, not 0 - and most
  #  controllers have only 1 namespace.
  LUN0 Nvme0n1p0
</pre><p>You should make a copy of the example configuration file, modify it to suit your environment, and then run the iscsi_tgt application and pass it the configuration file using the -c option. Right now, the target requires elevated privileges (root) to run.</p>
<pre class="fragment">app/iscsi_tgt/iscsi_tgt -c /path/to/iscsi.conf
</pre><h1><a class="anchor" id="iscsi_initiator_config"></a>
Configuring iSCSI Initiator</h1>
<p>The Linux initiator is open-iscsi.</p>
<p>Installing open-iscsi package Fedora: </p><pre class="fragment">yum install -y iscsi-initiator-utils
</pre><p>Ubuntu: </p><pre class="fragment">apt-get install -y open-iscsi
</pre><h1>Setup </h1>
<p>Edit /etc/iscsi/iscsid.conf </p><pre class="fragment">node.session.cmds_max = 4096
node.session.queue_depth = 128
</pre><p>iscsid must be restarted or receive SIGHUP for changes to take effect. To send SIGHUP, run: </p><pre class="fragment">killall -HUP iscsid
</pre><p>Recommended changes to /etc/sysctl.conf </p><pre class="fragment">net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 0

net.ipv4.tcp_rmem = 10000000 10000000 10000000
net.ipv4.tcp_wmem = 10000000 10000000 10000000
net.ipv4.tcp_mem = 10000000 10000000 10000000
net.core.rmem_default = 524287
net.core.wmem_default = 524287
net.core.rmem_max = 524287
net.core.wmem_max = 524287
net.core.optmem_max = 524287
net.core.netdev_max_backlog = 300000
</pre><p>Discovery</p>
<p>Assume target is at 192.168.1.5 </p><pre class="fragment">iscsiadm -m discovery -t sendtargets -p 192.168.1.5
</pre><p>Connect to target</p>
<pre class="fragment">iscsiadm -m node --login
</pre><p>At this point the iSCSI target should show up as SCSI disks. Check dmesg to see what they came up as.</p>
<p>Disconnect from target</p>
<pre class="fragment">iscsiadm -m node --logout
</pre><p>Deleting target node cache</p>
<pre class="fragment">iscsiadm -m node -o delete
</pre><p>This will cause the initiator to forget all previously discovered iSCSI target nodes.</p>
<p>Finding /dev/sdX nodes for iSCSI LUNs</p>
<pre class="fragment">iscsiadm -m session -P 3 | grep "Attached scsi disk" | awk '{print $4}'
</pre><p>This will show the /dev node name for each SCSI LUN in all logged in iSCSI sessions.</p>
<p>After the targets are connected, they can be tuned. For example if /dev/sdc is an iSCSI disk then the following can be done: Set noop to scheduler</p>
<pre class="fragment">echo noop &gt; /sys/block/sdc/queue/scheduler
</pre><p>Disable merging/coalescing (can be useful for precise workload measurements)</p>
<pre class="fragment">echo "2" &gt; /sys/block/sdc/queue/nomerges
</pre><p>Increase requests for block queue</p>
<pre class="fragment">echo "1024" &gt; /sys/block/sdc/queue/nr_requests
</pre> </div></div><!-- contents -->
<!-- start footer part -->
<section id="community">
  <div class="community">
    <div class="container">
      <div class="row">
        <div class="col-lg-6">
          <h2>Join Our Community:</h2>
        </div>
        <div class="col-lg-6">
          <ul class="list-inline community-box-buttons">
            <li>
              <a href="https://github.com/spdk/spdk" class="btn btn-default btn-lg">
                <img class="box-ico" src="http://www.spdk.io/img/ico/github.png"></img>
                <span class="box-name">github</span>
              </a>
            </li>
            <li>
              <a href="https://lists.01.org/mailman/listinfo/spdk" class="btn btn-default btn-lg">
                <img class="box-ico" src="http://www.spdk.io/img/ico/125a-email-message-solid.svg"></img>
                <span class="box-name">mailing list</span>
              </a>
            </li>
            <li>
              <a href="http://spdk.io/spdk/doc/" class="btn btn-default btn-lg">
                <img class="box-ico" src="http://www.spdk.io/img/ico/003-instructions.svg"></img>
                <span class="box-name">documentation</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  <!-- /.container -->
  </div>
</section>
<!-- /.banner -->
<!-- Footer -->
<footer>
  <div class="container text-center">
    <p class="copyright text-muted small">Copyright &copy; Intel Corporation. All Rights Reserved.</p>
  </div>
</footer>
</body>
</html>
