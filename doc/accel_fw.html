<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="generator" content="Doxygen 1.9.1" />
  <title>SPDK: Acceleration Framework</title>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/js/doxyboot.js"></script>
  <script type="text/javascript" src="navtree.js"></script>
  <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/css/spdk.css" rel="stylesheet" type="text/css">
</head>
<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark px-2">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/" aria-label="SPDK">
      <img src="/img/spdk.svg"  width="36" height="36" alt="Storage Performance Development Kit" />
    </a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <div class="navbar-nav mr-auto">
        <a class="nav-link header-link active" href="../doc/">Documentation</a>
        <a class="nav-link header-link" href="../development/">Development</a>
        <a class="nav-link header-link" href="../community/">Community</a>
        <a class="nav-link header-link" href="../blog/">Blog</a>
      </div>
      <div class="navbar-nav ml-auto mr-3">
        <a class="nav-link header-link" href="https://github.com/spdk/spdk">
          <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
        </a>
      </div>
    </div>
  </nav>
  <div class="container-fluid doc">
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('accel_fw.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Acceleration Framework </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_accel_fw"></a> SPDK provides a framework for abstracting general acceleration capabilities that can be implemented through plug-in modules and low-level libraries. These plug-in modules include support for hardware acceleration engines such as the Intel(R) I/O Acceleration Technology (IOAT) engine and the Intel(R) Data Streaming Accelerator (DSA) engine. Additionally, a software plug-in module exists to enable use of the framework in environments without hardware acceleration capabilities. ISA/L is used for optimized CRC32C calculation within the software module.</p>
<p>The framework includes an API for getting the current capabilities of the selected module. See <a href="https://spdk.io/doc/accel__engine_8h.html"><code>spdk_accel_get_capabilities</code></a> for more details. For the software module, all capabilities will be reported as supported. For the hardware modules, only functions accelerated by hardware will be reported however any function can still be called, it will just be backed by software if it is not reported as a supported capability.</p>
<h1><a class="anchor" id="accel_functions"></a>
Acceleration Framework Functions</h1>
<p>Functions implemented via the framework can be found in the DoxyGen documentation of the framework public header file here <a href="https://spdk.io/doc/accel__engine_8h.html">accel_engine.h</a></p>
<h1><a class="anchor" id="accel_dc"></a>
Acceleration Framework Design Considerations</h1>
<p>The general interface is defined by <code>/include/accel_engine.h</code> and implemented in <code>/lib/accel</code>. These functions may be called by an SPDK application and in most cases, except where otherwise documented, are asynchronous and follow the standard SPDK model for callbacks with a callback argument.</p>
<p>If the acceleration framework is started without initializing a hardware module, optimized software implementations of the functions will back the public API. Additionally, if any hardware module does not support a specific function and that hardware module is initialized, the specific function will fallback to a software optimized implementation. For example, IOAT does not support the dualcast function in hardware but if the IOAT module has been initialized and the public dualcast API is called, it will actually be done via software behind the scenes.</p>
<h1><a class="anchor" id="accel_libs"></a>
Acceleration Low Level Libraries</h1>
<p>Low level libraries provide only the most basic functions that are specific to the hardware. Low level libraries are located in the '/lib' directory with the exception of the software implementation which is implemented as part of the framework itself. The software low level library does not expose a public API. Applications may choose to interact directly with a low level library if there are specific needs/considerations not met via accessing the library through the framework/module. Note that when using the low level libraries directly, the framework abstracted interface is bypassed as the application will call the public functions exposed by the individual low level libraries. Thus, code written this way needs to be certain that the underlying hardware exists everywhere that it runs.</p>
<p>The low level library for IOAT is located in <code>/lib/ioat</code>. The low level library for DSA is in <code>/lib/idxd</code> (IDXD stands for Intel(R) Data Acceleration Driver). In <code>/lib/idxd</code> folder, SPDK supports to leverage both user space and kernel space driver to drive DSA devices. And the following describes each usage scenerio:</p>
<p>Leveraging user space idxd driver: The DSA devices are managed by the user space driver in a dedicated SPDK process, then the device cannot be shared by another process. The benefit of this usage is no kernel dependency.</p>
<p>Leveraging kernel space driver: The DSA devices are managed by kernel space drivers. And the Work queues inside the DSA device can be shared among different processes. Naturally, it can be used in cloud native scenerio. The drawback of this usage is the kernel dependency, i.e., idxd driver must be supported and loaded in the kernel.</p>
<h1><a class="anchor" id="accel_modules"></a>
Acceleration Plug-In Modules</h1>
<p>Plug-in modules depend on low level libraries to interact with the hardware and add additional functionality such as queueing during busy conditions or flow control in some cases. The framework in turn depends on the modules to provide the complete implementation of the acceleration component. A module must be selected via startup RPC when the application is started. Otherwise, if no startup RPC is provided, the framework is available and will use the software plug-in module.</p>
<h2><a class="anchor" id="accel_ioat"></a>
IOAT Module</h2>
<p>To use the IOAT engine, use the RPC <a href="https://spdk.io/doc/jsonrpc.html"><code>ioat_scan_accel_engine</code></a> before starting the application.</p>
<h2><a class="anchor" id="accel_idxd"></a>
IDXD Module</h2>
<p>To use the DSA engine, use the RPC <a href="https://spdk.io/doc/jsonrpc.html"><code>idxd_scan_accel_engine</code></a>. With an optional parameter of <code>-c</code> and providing a configuration number of either 0 or 1, users can determine which pre-defined configuration can be used. With an optional parameter of <code>-k</code> to use kernel or user space driver. These pre-defined configurations determine how the DSA engine will be setup in terms of work queues and engines. The DSA engine is very flexible allowing for various configurations of these elements to either account for different quality of service requirements or to isolate hardware paths where the back end media is of varying latency (i.e. persistent memory vs DRAM). The pre-defined configurations are as follows:</p>
<p>0: A single work queue backed with four DSA engines. This is a generic configuration that enables the hardware to best determine which engine to use as it pulls in new operations.</p>
<p>1: Two separate work queues each backed with two DSA engines. This is another generic configuration that is documented in the specification and allows the application to partition submissions across two work queues. This would be useful when different priorities might be desired per group.</p>
<p>There are several other configurations that are possible that include quality of service parameters on the work queues that are not currently utilized by the module. Specialized use of DSA may require different configurations that can be added to the module as needed.</p>
<p>When a new channel starts, a DSA device will be assigned to the channel. The accel idxd module has been tuned for the most likely best performance case. The result is that there is a limited number of channels that can be supported based on the number of DSA devices in the system. Additionally, for best performance, the accel idxd module will only use DSA devices on the same socket as the requesting channel/thread. If an error occurs on initialization indicating that there are no more DSA devices available either try fewer threads or, if on a 2 socket system, try spreading threads across cores if possible.</p>
<h2>How to use kernel idxd driver (#accel_idxd_kernel)</h2>
<p>There are several dependencies to leverage kernel idxd driver for driving DSA devices.</p>
<p>1 Linux kernel support: To leverage kernel space idxd driver, you need to have a Linux kernel with <code>idxd</code> driver loaded with scalable mode. And currently SPDK uses the character device while <code>idxd</code> driver is enabled in the kernel. So when booting the machine, we need to add additional configuration in the grub, i.e, revise the kernel boot commandline <code>intel_iommu=on,sm_on</code> with VT-d turned on in BIOS.</p>
<p>2 User library dependency: Users need to install <code>idxd-config</code> library. For example, users can download the library from <a href="https://github.com/intel/idxd-config">idxd-config repo</a>. After the library is installed, users can use the <code>accel-config</code> command to configure the work queues(WQs) of the idxd devices managed by the kernel with the following steps:</p>
<div class="fragment"><div class="line">accel-config disable-wq dsa0/wq0.1</div>
<div class="line">accel-config disable-device dsa0</div>
<div class="line">accel-config config-wq --group-id=0 --mode=dedicated --wq-size=16 --type=user --name=&quot;MyApp1&quot;</div>
<div class="line"> --priority=10 --block-on-fault=1 dsa0/wq0.1</div>
<div class="line">accel-config config-engine dsa0/engine0.1 --group-id=0</div>
<div class="line">accel-config enable-device dsa0</div>
<div class="line">accel-config enable-wq dsa0/wq0.1</div>
</div><!-- fragment --><p>For more details on the usage of <code>idxd-config</code>, please refer to <a href="https://github.com/intel/idxd-config/tree/master/Documentation/accfg">idxd-config usage</a>.</p>
<h2><a class="anchor" id="accel_sw"></a>
Software Module</h2>
<p>The software module is enabled by default. If no hardware engine is explicitly enabled via startup RPC as discussed earlier, the software module will use ISA-L if available for functions such as CRC32C. Otherwise, standard glibc calls are used to back the framework API.</p>
<h2><a class="anchor" id="batching"></a>
Batching</h2>
<p>Batching is exposed by the acceleration framework and provides an interface to batch sets of commands up and then submit them with a single command. The public API is consistent with the implementation however each plug-in module behaves differently depending on its capabilities.</p>
<p>The DSA engine has complete support for batching all supported commands together into one submission. This is advantageous as it reduces the overhead incurred in the submission process to the hardware.</p>
<p>The software engine supports batching only to be consistent with the framework API. In software there is no savings by batching sets of commands versus submitting them individually.</p>
<p>The IOAT engine supports batching but it is only beneficial for <code>memmove</code> and <code>memfill</code> as these are supported by the hardware. All other commands can be batched and the framework will manage all other commands via software. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
<ul>
        <li class="footer">Generated on Tue Nov 9 2021 04:04:29 for SPDK by
        <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.1 </li>
</ul>
</div>
</div>
</body>
</html>
